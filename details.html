<h1>Device Details</h1>

<script>
var device = "Monitor" // (new URL(window.location.href)).searchParams.get("device")

var pageTitle = document.getElementById("page-title")
pageTitle.textContent = device + ': Details'


$hk.itemsToReload.push({
    filename: "logs/Errorlog",
    responseType: 'text',
    completionHandler: function () {
        const log = document.querySelector("#log-1")
        log.querySelector("h4").textContent = this.responseURL.split('/').pop().split('?')[0]
        log.querySelector("pre").textContent = this.response
    }
})

$hk.itemsToReload.push({
    filename: "cgi-bin/pg-query.py?q=current",
    responseType: 'text',
    completionHandler: function () {
        const log = document.querySelector("#log-2")
        log.querySelector("h4").textContent = this.responseURL.split('/').pop() //.split('?')[0]
        log.querySelector("pre").textContent = this.response
    }
})

$hk.itemsToReload.push({
    filename: "cgi-bin/pg-query.py?q=history&device=Monitor&time=" + document.getElementById("time-range-selector").value,
    // filename: "json/pg-query_details.json", // for offline testing
    responseType: 'json',
    completionHandler: function () {
        $hk.plot.update("history-cpu", "CPUidle ", {"title": "CPU Usage [%]", "min": -1, "max": 101}, this.response)
        $hk.plot.update("history-temperature", "Temp", {"title": "Temperature [℃]", "min": 15, "max": 60}, this.response)
    }
})

$hk.itemsToReload.push({
    filename: "cgi-bin/pg-query.py?q=current&device=Monitor",
    // filename: "json/pg-query_overview.json", // for offline testing
    responseType: 'json',
    completionHandler: function () {
        let csl = document.getElementById("current-status-list")
        csl.innerHTML = '' // clear old data
        $hk.statusboard.listDeviceData(csl, this.response.devices[0], this.response.meta)

        let lu = document.querySelector("#current-status .title time")
        const d = new Date()
        lu.textContent = d.toLocaleString()
        lu.setAttribute("datetime", d.toISOString())
    }
})

trs = document.getElementById("time-range-selector")
trs.addEventListener('change', function () {
    // TODO: Can we rely on this always being the last entry?
    $hk.itemsToReload[$hk.itemsToReload.length-1].filename = "cgi-bin/pg-query.py?q=history&device=Monitor&time=" + document.getElementById("time-range-selector").value
    $hk.reloadAll()
})
</script>

<div class="box-wrapper"><div id="current-status" class="box">
    <div class="title">
        <div style="float: right;">
            <label for="time-range-selector">Show time range:</label>
            <select name="time-range-selector" id="time-range-selector">
                <option value="0.5h" selected>Last 30 minutes</option>
                <option value="2h">Last 2 hours</option>
                <option value="8h">Last 8 hours</option>
                <option value="1d">Last day</option>
                <option value="7d">Last week</option>
            </select>
        </div>
        <h2>Current status (Last updated: <time datetime=""></time>)</h2>
    </div>

    <div id="current-status-list" style="column-count: 3;">
        <p>Loading data …</p>
    </div>
</div></div>

<div class="plot-div" id="history-cpu"></div>
<div class="plot-div" id="history-temperature"></div>

<div class="log" id="log-1">
    <h4 class="title">Filename.txt</h4>
    <pre>[Content from some log file goes here]</pre>
</div>
<div class="log" id="log-2">
    <h4 class="title">Filename.txt</h4>
    <pre>[Content from some log file goes here]</pre>
</div>

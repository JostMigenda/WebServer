<html>
    <head>
        <meta charset="utf-8" />
        <title>Test page for making plots with plotly.js</title>
        <script src="plotly-latest.min.js"></script>
        <link rel="stylesheet" href="style.css">
        <script>
            let reloadIntervalID, rateSelector

            function setup() {
                rateSelector = document.getElementById("refresh-rate");
                rateSelector.addEventListener('change', setReloadInterval);

                reloadData()
                reloadIntervalID = setInterval(reloadData, Number(rateSelector.value))
            }

            function setReloadInterval() {
                let reloadInterval = Number(rateSelector.value)
                if (reloadInterval === 0) {
                    clearInterval(reloadIntervalID)
                    document.querySelector("body").style.backgroundColor = "red"
                } else {
                    clearInterval(reloadIntervalID)
                    reloadIntervalID = setInterval(reloadData, reloadInterval)
                    document.querySelector("body").style.backgroundColor = ""
                }
            }

            function reloadData() {
                updateStatusDisplay()
                plotSampleData()
                plotTemperatureData()

                // change border color to visualise reload frequency
                const pd = document.getElementsByClassName("plot-div")
                for (let item of pd) {
                    item.style.borderColor = item.style.borderColor == 'gray' ? '#800080' : 'gray'
                }
            }

            let layout = {
                title: "",
                // margin: { t: 100, b: 80, l: 80, r: 80 },
                // showlegend: false, // default: true
            }

            const config = {
                // staticPlot: true, // default: false
                responsive: true, // adapt when browser window is resized
                // displayModeBar: true, // default: only on mouse over
                modeBarButtonsToRemove: ['select2d', 'lasso2d', 'autoScale2d'],
                displaylogo: false, // don’t display plotly icon in ModeBar
                // toImageButtonOptions: {
                //     format: 'png', // one of png, svg, jpeg, webp
                //     filename: plot_id,
                //     height: 500,
                //     width: 700,
                //     scale: 1 // Multiply title/legend/axis/canvas sizes by this factor
                // }
            };

            function plotSampleData() {
                const plot_id = "plot1"
                const plot_layout = Object.create(layout)
                plot_layout.title = "How much I like …"
                const filename = "like.json" // hard-coded

                plotData(plot_id, plot_layout, filename)
            }

            function plotTemperatureData() {
                const plot_id = "plot2"
                const plot_layout = Object.create(layout)
                plot_layout.title = "Temperature"
                const filename = (new URL(window.location.href)).searchParams.get("filename")

                plotData(plot_id, plot_layout, filename)
            }

            // function to (re)load data and (re)draw plot
            function plotData(plot_id, plot_layout, filename) {
                // plot_id: id of <div> element where this plot will be displayed
                // plot_layout: Copy of `layout` object with e.g. title adjusted
                // filename: (relative or absolute) path of file containing raw data to plot

                // add timestamp to avoid browser caching, see https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest/Using_XMLHttpRequest#Bypassing_the_cache
                filename += ((/\?/).test(filename) ? "&" : "?") + (new Date()).getTime()
                let request = new XMLHttpRequest();
                request.open('GET', filename)
                request.responseType = 'json'
                request.send()
                request.onload = function () {
                    // get data from JSON object and display plot
                    let data = request.response
                    console.log("Updating " + plot_id + " with data from " + filename)
                    Plotly.newPlot(plot_id, data, plot_layout, config);
                }
            }

            function updateStatusDisplay() {
                const filename = "statusdisplay.json?" + (new Date()).getTime()
                let request = new XMLHttpRequest();
                request.open('GET', filename)
                request.responseType = 'json'
                request.send()
                request.onload = function () {
                    let devices = request.response
                    let statusdisplay = document.getElementById("status-display")
                    while (statusdisplay.hasChildNodes()) {
                        statusdisplay.removeChild(statusdisplay.firstChild)
                    }
                    devices.forEach(device => {
                        let statuslight = document.createElement("a")

                        // configure statuslight
                        statuslight.setAttribute("id", "statuslight-" + device["id"])
                        let colour = "green" // default, unless there is an issue
                        if (device["temperature"] > 22) {
                            colour = "red"
                        } else if (device["temperature"] == null) {
                            colour = "black"
                        }
                        statuslight.setAttribute("class", "statuslight " + colour)
                        statuslight.setAttribute("title", "ID: " + device["id"] + "; Temperature: " + device["temperature"])
                        statuslight.setAttribute("href", "details.html?deviceid=" + device["id"])

                        // display it
                        statusdisplay.appendChild(statuslight)
                    })
                }
            }
        </script>
    </head>
    <body style="max-width: 800px;" onload="setup();">
        <h1>Select a refresh rate</h1>
        <select id="refresh-rate">
            <!-- Values in milliseconds. -->
            <option value="2000">Every 2 Seconds</option>
            <option value="5000">Every 5 Seconds</option>
            <option value="60000" selected>Every Minute</option>
            <option value="0">Stop Refreshing</option>
        </select>

        <details open>
            <summary>
                <h2>Status Display</h2>
            </summary>
            <div id="status-display" class="plot-div"></div>
            <div id="status-display-details-view"></div><!-- TODO: add JS to create a table with info on specific device -->
        </details>

        <details id="plotly-handwritten">
            <summary>
                <h2>Sample Plots (handwritten in ECMAScript)</h2>
            </summary>
            <div id="plot1" class="plot-div"></div>

            Append "?filename=tempdata-barrel.json" to URL to test this:
            <div id="plot2" class="plot-div"></div>
        </details>

        <details id="python-generated">
            <summary>
                <h2>Sample Plot (Generated in Python)</h2>
            </summary>
            <div>
                <!--
                        Generated with the plotly Python library.
                        https://plotly.com/python/interactive-html-export/#controlling-the-size-of-the-html-file
                
                        >>> import plotly.graph_objects as go
                        >>> fig = go.Figure(data=go.Bar(y=[2, 3, 1, 5, 8, 4, 2, 6])) 
            >>> fig = go.Figure(data=go.Bar(y=[2, 3, 1, 5, 8, 4, 2, 6])) 
                        >>> fig = go.Figure(data=go.Bar(y=[2, 3, 1, 5, 8, 4, 2, 6])) 
                        >>> fig.write_html('figure-includable.html', full_html=False, include_plotlyjs=False)
                        -->
                <div id="4d33bc66-5fbf-435b-ac5f-6e13b493ad6e" class="plotly-graph-div" style="height:100%; width:100%;"></div>
                <script type="text/javascript">
                    window.PLOTLYENV = window.PLOTLYENV || {};
                    if (document.getElementById("4d33bc66-5fbf-435b-ac5f-6e13b493ad6e")) {
                        Plotly.newPlot(
                            '4d33bc66-5fbf-435b-ac5f-6e13b493ad6e',
                            [{ "type": "bar", "y": [2, 3, 1, 5, 8, 4, 2, 6] }],
                            { "template": { "data": { "bar": [{ "error_x": { "color": "#2a3f5f" }, "error_y": { "color": "#2a3f5f" }, "marker": { "line": { "color": "#E5ECF6", "width": 0.5 } }, "type": "bar" }], "barpolar": [{ "marker": { "line": { "color": "#E5ECF6", "width": 0.5 } }, "type": "barpolar" }], "carpet": [{ "aaxis": { "endlinecolor": "#2a3f5f", "gridcolor": "white", "linecolor": "white", "minorgridcolor": "white", "startlinecolor": "#2a3f5f" }, "baxis": { "endlinecolor": "#2a3f5f", "gridcolor": "white", "linecolor": "white", "minorgridcolor": "white", "startlinecolor": "#2a3f5f" }, "type": "carpet" }], "choropleth": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "type": "choropleth" }], "contour": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "type": "contour" }], "contourcarpet": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "type": "contourcarpet" }], "heatmap": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "type": "heatmap" }], "heatmapgl": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "type": "heatmapgl" }], "histogram": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "histogram" }], "histogram2d": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "type": "histogram2d" }], "histogram2dcontour": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "type": "histogram2dcontour" }], "mesh3d": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "type": "mesh3d" }], "parcoords": [{ "line": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "parcoords" }], "pie": [{ "automargin": true, "type": "pie" }], "scatter": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scatter" }], "scatter3d": [{ "line": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scatter3d" }], "scattercarpet": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scattercarpet" }], "scattergeo": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scattergeo" }], "scattergl": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scattergl" }], "scattermapbox": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scattermapbox" }], "scatterpolar": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scatterpolar" }], "scatterpolargl": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scatterpolargl" }], "scatterternary": [{ "marker": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "type": "scatterternary" }], "surface": [{ "colorbar": { "outlinewidth": 0, "ticks": "" }, "colorscale": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "type": "surface" }], "table": [{ "cells": { "fill": { "color": "#EBF0F8" }, "line": { "color": "white" } }, "header": { "fill": { "color": "#C8D4E3" }, "line": { "color": "white" } }, "type": "table" }] }, "layout": { "annotationdefaults": { "arrowcolor": "#2a3f5f", "arrowhead": 0, "arrowwidth": 1 }, "coloraxis": { "colorbar": { "outlinewidth": 0, "ticks": "" } }, "colorscale": { "diverging": [[0, "#8e0152"], [0.1, "#c51b7d"], [0.2, "#de77ae"], [0.3, "#f1b6da"], [0.4, "#fde0ef"], [0.5, "#f7f7f7"], [0.6, "#e6f5d0"], [0.7, "#b8e186"], [0.8, "#7fbc41"], [0.9, "#4d9221"], [1, "#276419"]], "sequential": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]], "sequentialminus": [[0.0, "#0d0887"], [0.1111111111111111, "#46039f"], [0.2222222222222222, "#7201a8"], [0.3333333333333333, "#9c179e"], [0.4444444444444444, "#bd3786"], [0.5555555555555556, "#d8576b"], [0.6666666666666666, "#ed7953"], [0.7777777777777778, "#fb9f3a"], [0.8888888888888888, "#fdca26"], [1.0, "#f0f921"]] }, "colorway": ["#636efa", "#EF553B", "#00cc96", "#ab63fa", "#FFA15A", "#19d3f3", "#FF6692", "#B6E880", "#FF97FF", "#FECB52"], "font": { "color": "#2a3f5f" }, "geo": { "bgcolor": "white", "lakecolor": "white", "landcolor": "#E5ECF6", "showlakes": true, "showland": true, "subunitcolor": "white" }, "hoverlabel": { "align": "left" }, "hovermode": "closest", "mapbox": { "style": "light" }, "paper_bgcolor": "white", "plot_bgcolor": "#E5ECF6", "polar": { "angularaxis": { "gridcolor": "white", "linecolor": "white", "ticks": "" }, "bgcolor": "#E5ECF6", "radialaxis": { "gridcolor": "white", "linecolor": "white", "ticks": "" } }, "scene": { "xaxis": { "backgroundcolor": "#E5ECF6", "gridcolor": "white", "gridwidth": 2, "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white" }, "yaxis": { "backgroundcolor": "#E5ECF6", "gridcolor": "white", "gridwidth": 2, "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white" }, "zaxis": { "backgroundcolor": "#E5ECF6", "gridcolor": "white", "gridwidth": 2, "linecolor": "white", "showbackground": true, "ticks": "", "zerolinecolor": "white" } }, "shapedefaults": { "line": { "color": "#2a3f5f" } }, "ternary": { "aaxis": { "gridcolor": "white", "linecolor": "white", "ticks": "" }, "baxis": { "gridcolor": "white", "linecolor": "white", "ticks": "" }, "bgcolor": "#E5ECF6", "caxis": { "gridcolor": "white", "linecolor": "white", "ticks": "" } }, "title": { "x": 0.05 }, "xaxis": { "automargin": true, "gridcolor": "white", "linecolor": "white", "ticks": "", "title": { "standoff": 15 }, "zerolinecolor": "white", "zerolinewidth": 2 }, "yaxis": { "automargin": true, "gridcolor": "white", "linecolor": "white", "ticks": "", "title": { "standoff": 15 }, "zerolinecolor": "white", "zerolinewidth": 2 } } } },
                            { "responsive": true }
                        )
                    };
                </script>
            </div>
        </details>
        
        <details>
            <summary>
                <h2>Detector Overview page</h2>
            </summary>
            <div id="wrapper">
                <div class="item" style="height: 200px;">1</div>
                <div class="item" style="height: 300px;">2</div>
                <div class="item" style="height: 100px;">3</div>
                <div class="item" style="height: 200px;">4</div>
                <div class="item" style="height: 100px;">5</div>
                <div class="item" style="height: 300px;">6</div>
                <div class="item" style="height: 100px;">7</div>
                <div class="item" style="height: 100px;">8</div>
            </div>
        </details>
    </body>
</html>